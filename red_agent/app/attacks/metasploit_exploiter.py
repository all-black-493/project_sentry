from fastapi import APIRouter, HTTPException
from pydantic import BaseModel, HttpUrl, Field
from pymetasploit3.msfrpc import MsfRpcClient
import os

router = APIRouter()


class MsfRequest(BaseModel):
    target_url: HttpUrl = Field(..., description="Target host or IP")
    exploit_name: str = Field(..., description="Metasploit exploit module path")
    payload: str = Field(..., description="Payload name")


class MsfResponse(BaseModel):
    job_id: int
    session_id: int | None
    success: bool
    details: dict


class MetasploitExploiter:
    def __init__(self):
        self.client = MsfRpcClient(
            password=os.getenv("MSF_RPC_PASS"),
            user="msfuser",
            server="127.0.0.1",
            port=55553,
        )

    def configure_exploit(self, exploit_name: str, target: str, payload: str) -> dict:
        """
        Load and configure a Metasploit exploit module and associated payload
        """

        mod = self.client.modules.use("exploit", exploit_name)
        mod["RHOSTS"] = target
        mod["PAYLOAD"] = payload

        return {"module": mod, "target": target}

    def run(self, mod) -> dict:
        """
        Execute the exploit and return job and session metadata
        """

        job_id = mod.execute()
        import time

        time.sleep(2)
        sessions = self.client.sessions.list
        session_id = next(iter(sessions), None)
        return {"job_id": job_id, "session_id": session_id}


@router.post("/metasploit/exploit", response_model=MsfResponse)
async def launch_exploit(req: MsfRequest):
    if not (req.target_url and req.exploit_name and req.payload):
        raise HTTPException(status_code=400, detail="All fields required")
    exploiter = MetasploitExploiter()
    config = exploiter.configure_exploit(
        req.exploit_name, req.target_url.host, req.payload
    )
    result = exploiter.run(config["module"])
    success = result["session_id"] is not None
    return MsfResponse(
        job_id=result["job_id"],
        session_id=result["session_id"],
        success=success,
        details={"target": req.target_url, "exploit": req.exploit_name},
    )
